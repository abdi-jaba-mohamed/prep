var FederatedLogin=function(){var e;return new function(){var v=this,p={},m=!1;FederatedLoginService.call(v),v._ajax=function(e){"undefined"!=typeof base_url&&0!==e.url.indexOf("http")&&(e.url=base_url+e.url),LPServer.ajax(e)},v.login=function(a,n){a=fix_username(a),v.getPassword(a,function(e,r,t,o){setFragmentId(t,o),LP_do_login(a,e,n,void 0,void 0,void 0,void 0,void 0,void 0,r)},lpshowError)};var f=function(e,r){if(e.keypair){var t,o=(new DOMParser).parseFromString(atob(r),"application/xml"),a=o.querySelector('Attribute[Name="LastPassKeyPart"]').childNodes[0].textContent,n=o.querySelector('Attribute[Name="LastPassKeyPartSignature"]').childNodes[0].textContent,i=v._decryptK1WithPrivateKey(atob(a),e.keypair.privateKey);e.valid=!!i&&s(i,n),e.submitted=!0,e.valid||v._handleError(e.error,new Error(gs("K1 not valid!")))}},t=function(e){var r=forge.md.sha256.create();return r.update(e),btoa(r.digest().bytes())},s=function(e,r){return t(e)===r},o=function(e){var t={},r;return e.split("&").forEach(function(e){var r=e.split("=");2===r.length&&(t[r[0]]=decodeURIComponent(r[1]))}),t},g=function(e){try{if(e&&e.formData&&e.formData.SAMLResponse&&1===e.formData.SAMLResponse.length)return e.formData.SAMLResponse[0];if(e&&e.raw){var r=e.raw.reduce(function(e,r){return e+String.fromCharCode.apply(null,new Uint8Array(r.bytes))},"");if(0<r.length){var t=o(r);if(t.SAMLResponse)return t.SAMLResponse}}}catch(e){console.log(e)}return null};v.getPasswordSaml=function(l,c,u){l=fix_username(l),LPPlatform.getCurrentTabDetails(function(d){v._initiate(l,function(n,i){var s={valid:!1,idp:n,keypair:i,submitted:!1,error:u};LPPlatform.openTab({extension:!0,url:n.IdentityProviderURL+"/auth/saml2/"+n.IdentityProviderGUID,loadHandler:function(a){s.cleanup=LPPlatform.onBeforeNavigate(function(e,r){var t=/\/auth\/saml2\/success\/(.*)$/.exec(e);if(t&&2===t.length)return s.valid||!i?v._getAuthInfo(l,t[1],function(r){v._assemblePassword(l,i,r,function(e){c(e,r.authSessionId)},u)},u):v._handleError(u,new Error(gs("K1 not valid!"))),s.submitted=!0,LPPlatform.closeTab(a.tabDetails),LPPlatform.activateTab(d),!1;if(i&&!s.valid&&0===e.indexOf(n.IdentityProviderURL)){var o=g(r);if(o)return f(s,o),s.valid}},a.tabDetails),p[a.tabDetails.tabID]=s},closeHandler:function(){s.submitted||v._handleError(u,new Error(gs("Federated login tab closed!")))}})})})},v.parseJwt=function(e){var r,t;return(new Oidc.UserManager)._joseUtil.parseJwt(e).payload},v.getPassword=function(p,f,g){p=fix_username(p),v.clearCache(),LPPlatform.getCurrentTabDetails(function(e){v._initiate(p,function(e,r){var l={valid:!1,idp:e,keypair:r,submitted:!1,error:g};if(l.idp.type<=2)v.getPasswordSaml(p,f,g);else{3!=l.idp.type&&g(),Oidc.Log.logger=console,Oidc.Log.level=Oidc.Log.INFO;var t="openid email profile";l.idp.Provider===v.OIDC_PROVIDERS.OktaWithoutAuthorizationServer?t+=" groups":l.idp.Provider===v.OIDC_PROVIDERS.Google&&(t="openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.install https://www.googleapis.com/auth/drive.file");var c={authority:l.idp.OpenIDConnectAuthority,client_id:l.idp.OpenIDConnectClientId,redirect_uri:"https://accounts.lastpass.com/federated/oidcredirect.html",response_type:l.idp.PkceEnabled?"code":"id_token token",response_mode:l.idp.PkceEnabled?"fragment":null,scope:t,signingKeys:l.idp.OpenIDConnectKeys};l.idp.IsEmailHintDisabled||(c.extraQueryParams={login_hint:p});var u=v.getOIDCProviderName(l.idp.Provider),o=new Oidc.OidcClient(c);o.createSigninRequest().then(function(e){if(m)m=!1;else{m=!0;var r=l.idp.PkceEnabled&&e.url.indexOf("&nonce=")<0?"&nonce="+rand_str(16):"";LPPlatform.openTab({extension:!0,url:e.url+r,closeHandler:function(){m=!1,l.submitted||v._handleError(g,new Error(gs("Federated login tab closed!")))},loadHandler:function(){},onBeforeRequestCallback:function(e,r,d){function t(e){return[sprintf(gs("%s reported a problem during login."),u),sprintf(gs("Contact your %s administrator for assistance."),u),sprintf(gs("Hereâ€™s the message from %s:"),u),e].join("<br/><br/>")}/https:\/\/accounts\.lastpass\.com\/federated\/oidcredirect\.html.*/.test(e)&&o.processSigninResponse(e).then(function(e){if(l.submitted=!0,LPPlatform.closeTab({tabID:d}),m=!1,e.error)return console.log(e.error),v._handleError(g,new Error(getErrorMessage(e.error))),!1;if(!e.profile)return v._handleError(g,new Error(gs("No profile information."))),!1;var r=e.profile.email?e.profile.email.toLowerCase():void 0,t=e.profile.preferred_username?e.profile.preferred_username.toLowerCase():void 0;if(r!=p.toLowerCase()&&t!=p.toLowerCase()){var o=[sprintf(gs("Use the same account to log in to both %s and LastPass."),u),"<br/><br/>",sprintf(gs("Current %s account:"),u)+" "+(r||t||gs("unknown")),"<br/>",gs("Attempted LastPass account:")+" "+p].join("");return v._handleError(g,new Error(o)),!1}var a=null;if(l.idp.Provider==v.OIDC_PROVIDERS.Okta||l.idp.Provider==v.OIDC_PROVIDERS.OktaWithoutAuthorizationServer){var n;if(l.idp.Provider==v.OIDC_PROVIDERS.Okta)v.parseJwt(e.access_token)&&(a=v.parseJwt(e.access_token).LastPassK1);else l.idp.Provider==v.OIDC_PROVIDERS.OktaWithoutAuthorizationServer&&(a=e.profile.LastPassK1);a&&33==a.length||v._handleError(g,new Error(gs("LastPassK1 is missing or has invalid length.")))}var i=v.GRAPH_API_HOST.Com;l.idp.Provider===v.OIDC_PROVIDERS.Azure&&0<c.authority.indexOf("microsoftonline.us")&&(i=v.GRAPH_API_HOST.Us);var s={idToken:e.id_token,accessToken:e.access_token,companyId:l.idp.CompanyId,alpUrl:alp_url,provider:l.idp.Provider,oktaK1:a,graphApiHost:i};return v._assemblePasswordForOIDC(s,f,g),!0}).catch(function(e){console.log(e);var r=decodeURIComponent(e.error_description.replace(/\+/g,"%20"));v._handleError(g,new Error(t(r)))})}})}})}})})},v.validateK1Encryption=function(e,r,t){var o=!0,a=p[t.tabID];a&&a.keypair&&(f(a,e),o=a.valid),r&&r(o)},LPPlatform.onTabClosed(function(e){p[e]&&(p[e].cleanup(),delete p[e])})}}();